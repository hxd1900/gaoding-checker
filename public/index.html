<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¨¿å®šè®¾è®¡å›¾å±‚æ‰¹é‡æ£€æµ‹å™¨</title>
    <!-- ä½¿ç”¨æœ¬åœ° CSS -->
    <link href="style.css" rel="stylesheet">
    <style>
        /* é’ˆå¯¹æˆªå›¾é£æ ¼çš„ç‰¹å®šè¦†ç›–æ ·å¼ */
        body { background-color: #f8f9fa; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .container { max-width: 1000px; margin-top: 50px; }
        
        h2 { text-align: center; margin-bottom: 30px; font-weight: 600; font-size: 1.5rem; }
        
        .card { border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-radius: 8px; margin-bottom: 25px; padding: 20px; }
        .card-body { padding: 0; }
        
        .form-label { font-weight: 600; margin-bottom: 10px; display: block; }
        .form-control { border-radius: 4px; border: 1px solid #ced4da; padding: 12px; font-size: 14px; }
        .form-text { color: #6c757d; font-size: 12px; margin-top: 8px; margin-bottom: 15px; }
        
        .btn { padding: 8px 16px; font-size: 14px; border-radius: 4px; border: none; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background-color: #0d6efd; color: white; }
        .btn-success { background-color: #198754; color: white; }
        .btn-warning { background-color: #ffc107; color: #000; }
        .btn-secondary { background-color: #6c757d; color: white; }
        
        /* è¡¨æ ¼æ ·å¼å¤åˆ» */
        #resultArea h4 { font-size: 16px; font-weight: 600; margin-bottom: 15px; }
        .table { width: 100%; border-collapse: collapse; background: white; }
        .table th { background-color: #f8f9fa; border-bottom: 2px solid #dee2e6; color: #495057; font-weight: 600; text-align: left; padding: 12px; font-size: 13px; }
        .table td { padding: 12px; border-bottom: 1px solid #dee2e6; font-size: 13px; color: #212529; vertical-align: middle; }
        .table tr:last-child td { border-bottom: none; }
        
        /* çŠ¶æ€æ ·å¼ */
        .status-pass { color: #198754; font-weight: bold; }
        .status-reject { color: #dc3545; font-weight: bold; }
        .status-failed { color: #dc3545; }
        .text-success { color: #198754; }
        .text-danger { color: #dc3545; }
        
        /* é“¾æ¥é¢œè‰² */
        a { color: #0d6efd; text-decoration: none; }
        a:hover { text-decoration: underline; }
        
        /* è¿›åº¦é®ç½© */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999;
            display: none; justify-content: center; align-items: center;
            flex-direction: column;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ¨ ç¨¿å®šè®¾è®¡å›¾å±‚æ‰¹é‡æ£€æµ‹å™¨</h2>
        
        <div class="card">
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">è¯·è¾“å…¥æ¨¡æ¿ ID (æ¯è¡Œä¸€ä¸ª)</label>
                    <textarea id="inputIds" class="form-control" rows="5" placeholder="195690666
195667399
195662758
195667140"></textarea>
                    <div class="form-text">æ”¯æŒæ‰¹é‡è¾“å…¥ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨é€ä¸ªæ£€æµ‹ã€‚</div>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" onclick="startCheck()" id="btnStart">ğŸš€ å¼€å§‹æ£€æµ‹</button>
                    <button class="btn btn-warning" onclick="pauseCheck()" id="btnPause" disabled>â¸ åœæ­¢æ£€æµ‹</button>
                    <button class="btn btn-success" onclick="resumeCheck()" id="btnResume" style="display:none;">â–¶ ç»§ç»­æ£€æµ‹</button>
                    <button class="btn btn-success" onclick="exportCsv()" id="btnExport" disabled>ğŸ“¥ å¯¼å‡º Excel (CSV)</button>
                </div>
                <div class="mt-2 text-muted small" style="font-size: 12px; margin-top: 10px;">
                    <span id="statusText"></span>
                </div>
            </div>
        </div>

        <div class="card" id="resultArea" style="display: none;">
            <h4>æ£€æµ‹ç»“æœ</h4>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 15%;">æ¨¡æ¿ID</th>
                            <th style="width: 10%;">æ£€æµ‹çŠ¶æ€</th>
                            <th style="width: 10%;">å®¡æ ¸ç»“æœ</th>
                            <th style="width: 35%;">å®¡æ ¸è¯¦æƒ…</th>
                            <th style="width: 10%;">å›¾å±‚æ€»æ•°</th>
                            <th style="width: 10%;">å¤±è´¥åŸå› </th>
                        </tr>
                    </thead>
                    <tbody id="resultTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- è¿›åº¦é®ç½© (æ”¹ä¸ºéæ¨¡æ€ï¼Œå…è®¸ç‚¹å‡»åœæ­¢) -->
    <div class="loading-overlay" id="loading" style="background: rgba(255,255,255,0.9);">
        <div class="spinner-border text-primary" role="status"></div>
        <h5 class="mt-3" id="loadingText">æ­£åœ¨åˆå§‹åŒ–...</h5>
        <button class="btn btn-danger mt-3" onclick="pauseCheck()">åœæ­¢æ£€æµ‹</button>
    </div>

    <script>
        let currentResults = [];
        let pendingIds = [];
        let isPaused = false;
        let isRunning = false;

        async function startCheck() {
            const input = document.getElementById('inputIds').value;
            const ids = input.split(/[\n,ï¼Œ]/).map(s => s.trim()).filter(s => s);
            
            if (ids.length === 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ ID');
                return;
            }

            // é‡ç½®çŠ¶æ€
            document.getElementById('resultArea').style.display = 'block';
            document.getElementById('resultTableBody').innerHTML = '';
            document.getElementById('btnExport').disabled = true;
            document.getElementById('btnStart').disabled = true;
            document.getElementById('btnPause').disabled = false;
            document.getElementById('btnResume').style.display = 'none';
            
            currentResults = [];
            pendingIds = [...ids];
            isPaused = false;
            
            await processQueue();
        }

        async function pauseCheck() {
            isPaused = true;
            document.getElementById('statusText').innerText = 'æ­£åœ¨åœæ­¢... (å®Œæˆå½“å‰é¡¹ååœæ­¢)';
            document.getElementById('btnPause').disabled = true;
            // å¦‚æœé®ç½©å±‚è¿˜åœ¨æ˜¾ç¤ºï¼Œæ‰‹åŠ¨éšè—å®ƒ
            document.getElementById('loading').style.display = 'none';
        }

        async function resumeCheck() {
            isPaused = false;
            document.getElementById('btnResume').style.display = 'none';
            document.getElementById('btnPause').disabled = false;
            await processQueue();
        }

        async function processQueue() {
            if (isRunning) return;
            isRunning = true;

            const total = currentResults.length + pendingIds.length;
            const statusEl = document.getElementById('statusText');

            while (pendingIds.length > 0) {
                if (isPaused) {
                    statusEl.innerHTML = `<span class="text-warning">â¸ å·²æš‚åœ</span> - å‰©ä½™ ${pendingIds.length} ä¸ªå¾…æ£€æµ‹`;
                    document.getElementById('btnResume').style.display = 'inline-block';
                    document.getElementById('btnExport').disabled = false; // æš‚åœæ—¶ä¹Ÿå…è®¸å¯¼å‡º
                    isRunning = false;
                    return;
                }

                const id = pendingIds.shift();
                const currentIndex = currentResults.length + 1;
                
                statusEl.innerText = `æ­£åœ¨æ£€æµ‹: ${id} (${currentIndex}/${total})...`;
                
                // æ¸²æŸ“ä¸€è¡Œå ä½
                const tr = renderRowPlaceholder(id);

                try {
                    const response = await fetch('/api/check', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ids: [id] }) 
                    });
                    
                    const data = await response.json();
                    
                    if (data.results && data.results.length > 0) {
                        const result = data.results[0];
                        currentResults.push(result);
                        updateRow(tr, result);
                    }
                } catch (e) {
                    console.error(`ID ${id} æ£€æµ‹å¤±è´¥`, e);
                    const errorResult = {
                        id: id,
                        process_status: 'failed',
                        audit_result: null,
                        error: 'ç½‘ç»œè¯·æ±‚é”™è¯¯'
                    };
                    currentResults.push(errorResult);
                    updateRow(tr, errorResult);
                }
            }

            statusEl.innerText = 'âœ… æ£€æµ‹å®Œæˆ';
            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnPause').disabled = true;
            document.getElementById('btnExport').disabled = false;
            isRunning = false;
        }

        function renderRowPlaceholder(id) {
            const tbody = document.getElementById('resultTableBody');
            const tr = document.createElement('tr');
            tr.id = `row-${id}`;
            tr.innerHTML = `
                <td><a href="https://www.gaoding.com/editor/design?id=${id}" target="_blank">${id}</a></td>
                <td><div class="spinner-border spinner-border-sm text-primary" role="status"></div> æ£€æµ‹ä¸­...</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            `;
            tbody.appendChild(tr);
            tr.scrollIntoView({ behavior: 'smooth', block: 'end' });
            return tr;
        }

        function updateRow(tr, item) {
            // 2. æ£€æµ‹çŠ¶æ€
            let processStatusHtml = '';
            if (item.process_status === 'detected') {
                processStatusHtml = '<span>æˆåŠŸ</span>';
            } else {
                processStatusHtml = `<span class="text-danger">å¤±è´¥</span>`;
            }

            // 3. å®¡æ ¸ç»“æœ
            let auditHtml = '';
            if (item.process_status === 'failed') {
                auditHtml = '<span class="status-failed">æ£€æµ‹å¤±è´¥</span>';
            } else if (item.audit_result === 'pass') {
                auditHtml = '<span class="status-pass">âœ… é€šè¿‡</span>';
            } else {
                auditHtml = '<span class="status-reject">âŒ ä¸é€šè¿‡</span>';
            }

            // 4. æ•°æ®æå–
            const data = item.data || {};
            const total = data.total || 0;
            
            // 5. è¯¦æƒ… & å¤±è´¥åŸå› 
            let failReason = '';
            let detail = item.detail || '';
            let detailClass = "text-muted small";
            
            if (item.process_status === 'failed') {
                failReason = item.error || 'æœªçŸ¥é”™è¯¯';
                detail = '-';
            } else if (item.audit_result === 'pass') {
                // å¼ºåˆ¶æ˜¾ç¤ºæ ‡å‡†é€šè¿‡æ–‡æ¡ˆ
                detail = 'å›¾å±‚åˆ†å±‚åˆç†ã€æ–‡å­—å‡å¯ç¼–è¾‘';
            } else {
                // ä¸é€šè¿‡çš„æƒ…å†µ
                detailClass = "text-danger small"; // çº¢è‰²å­—ä½“
                // å¦‚æœ detail ä¸­åŒ…å« "ç–‘ä¼¼æ–‡å­—"ï¼Œè¯´æ˜æ˜¯ OCR é—®é¢˜
                if (detail && detail.includes('ç–‘ä¼¼æ–‡å­—') && !detail.includes('å­˜åœ¨ä¸å¯ç¼–è¾‘æ–‡å­—')) {
                    detail = '<div>å­˜åœ¨ä¸å¯ç¼–è¾‘æ–‡å­—</div><div style="margin-top:4px;">' + detail + '</div>';
                }
                // å¦‚æœæ˜¯åŸºç¡€åˆ†å±‚é—®é¢˜ï¼Œä¿æŒåŸæ ·ï¼ˆå¦‚â€œæ— å›¾å±‚åˆ†å±‚â€ï¼‰
                if (!detail || detail === '-') detail = 'ä¸ç¬¦åˆè§„èŒƒ';
            }
            
            const sysErrorDisplay = item.process_status === 'failed' ? failReason : '';

            tr.innerHTML = `
                <td><a href="https://www.gaoding.com/editor/design?id=${item.id}" target="_blank">${item.id}</a></td>
                <td>${processStatusHtml}</td>
                <td>${auditHtml}</td>
                <td class="${detailClass}">${detail}</td>
                <td><strong>${total}</strong></td>
                <td class="text-danger small">${sysErrorDisplay}</td>
            `;
        }

        // ä½¿ç”¨åŸç”Ÿ JS å¯¼å‡º CSV
        function exportCsv() {
            if (currentResults.length === 0) return;

            // 1. å®šä¹‰è¡¨å¤´
            const headers = ['æ¨¡æ¿ID', 'æ£€æµ‹çŠ¶æ€', 'å®¡æ ¸ç»“æœ', 'å®¡æ ¸è¯¦æƒ…', 'å›¾å±‚æ€»æ•°', 'å¤±è´¥åŸå› '];
            
            // 2. è½¬æ¢æ•°æ®
            const rows = currentResults.map(item => {
                let statusStr = '';
                if (item.process_status === 'failed') statusStr = 'æ£€æµ‹å¤±è´¥';
                else if (item.audit_result === 'pass') statusStr = 'é€šè¿‡';
                else statusStr = 'ä¸é€šè¿‡';
                
                const data = item.data || {};
                
                // --- é€»è¾‘ä¸ updateRow ä¿æŒä¸€è‡´ ---
                let detail = item.detail || '';
                let failReason = '';

                if (item.process_status === 'failed') {
                    failReason = item.error || 'æœªçŸ¥é”™è¯¯';
                    detail = '-';
                } else if (item.audit_result === 'pass') {
                    // å¼ºåˆ¶æ˜¾ç¤ºæ ‡å‡†é€šè¿‡æ–‡æ¡ˆ
                    detail = 'å›¾å±‚åˆ†å±‚åˆç†ã€æ–‡å­—å‡å¯ç¼–è¾‘';
                } else {
                    // ä¸é€šè¿‡çš„æƒ…å†µ
                    if (detail && detail.includes('ç–‘ä¼¼æ–‡å­—') && !detail.includes('å­˜åœ¨ä¸å¯ç¼–è¾‘æ–‡å­—')) {
                        // CSV é‡Œç”¨æ¢è¡Œç¬¦ä»£æ›¿ HTML æ ‡ç­¾
                        detail = 'å­˜åœ¨ä¸å¯ç¼–è¾‘æ–‡å­—\n' + detail;
                    }
                    if (!detail || detail === '-') detail = 'ä¸ç¬¦åˆè§„èŒƒ';
                }
                // --------------------------------

                return [
                    item.id,
                    item.process_status === 'detected' ? 'æˆåŠŸ' : 'å¤±è´¥',
                    statusStr,
                    `"${detail.replace(/"/g, '""')}"`,
                    data.total || 0,
                    `"${failReason.replace(/"/g, '""')}"`
                ];
            });
            
            // ... (åç»­å¯¼å‡ºé€»è¾‘ä¸å˜)
            let csvContent = '\uFEFF'; 
            csvContent += headers.join(',') + '\n';
            csvContent += rows.map(e => e.join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `ç¨¿å®šå›¾å±‚æ£€æµ‹æŠ¥å‘Š_${new Date().getTime()}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    </script>
</body>
</html>